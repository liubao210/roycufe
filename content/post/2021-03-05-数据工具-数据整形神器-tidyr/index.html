---
title: '[数据工具]数据整形神器 - tidyr'
author: baoliu
date: '2021-03-05'
slug: []
categories:
  - R
tags:
  - tidyverse
  - tidyr
---

<script src="index_files/header-attrs/header-attrs.js"></script>
<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>


<div id="tidyr" class="section level1">
<h1><strong>tidyr</strong></h1>
<p><strong>Tidyr</strong>(<a href="https://tidyr.tidyverse.org/" class="uri">https://tidyr.tidyverse.org/</a>) 是数据处理经常使用的package,主要用数据形状的改变，处理缺失值等，一般情况作为dplyr的上游处理步骤。</p>
<p><strong>主要功能</strong>：<br />
- <strong>长宽数据转换</strong> (pivot_longer pivot_wider)<br />
- <strong>数据分割与合并</strong> (separate unite)<br />
- <strong>缺失数据处理</strong> (drop_na fill)<br />
- <strong>嵌套数据处理</strong> (nest unnest unnest_wider hoist)</p>
<div id="长宽数据转换" class="section level2">
<h2>长宽数据转换</h2>
<pre class="r"><code>library(dplyr)
library(tibble)
library(tidyr)

mtcars = mtcars %&gt;% rownames_to_column(&#39;name&#39;)
DT::datatable(mtcars)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Mazda RX4","Mazda RX4 Wag","Datsun 710","Hornet 4 Drive","Hornet Sportabout","Valiant","Duster 360","Merc 240D","Merc 230","Merc 280","Merc 280C","Merc 450SE","Merc 450SL","Merc 450SLC","Cadillac Fleetwood","Lincoln Continental","Chrysler Imperial","Fiat 128","Honda Civic","Toyota Corolla","Toyota Corona","Dodge Challenger","AMC Javelin","Camaro Z28","Pontiac Firebird","Fiat X1-9","Porsche 914-2","Lotus Europa","Ford Pantera L","Ferrari Dino","Maserati Bora","Volvo 142E"],[21,21,22.8,21.4,18.7,18.1,14.3,24.4,22.8,19.2,17.8,16.4,17.3,15.2,10.4,10.4,14.7,32.4,30.4,33.9,21.5,15.5,15.2,13.3,19.2,27.3,26,30.4,15.8,19.7,15,21.4],[6,6,4,6,8,6,8,4,4,6,6,8,8,8,8,8,8,4,4,4,4,8,8,8,8,4,4,4,8,6,8,4],[160,160,108,258,360,225,360,146.7,140.8,167.6,167.6,275.8,275.8,275.8,472,460,440,78.7,75.7,71.1,120.1,318,304,350,400,79,120.3,95.1,351,145,301,121],[110,110,93,110,175,105,245,62,95,123,123,180,180,180,205,215,230,66,52,65,97,150,150,245,175,66,91,113,264,175,335,109],[3.9,3.9,3.85,3.08,3.15,2.76,3.21,3.69,3.92,3.92,3.92,3.07,3.07,3.07,2.93,3,3.23,4.08,4.93,4.22,3.7,2.76,3.15,3.73,3.08,4.08,4.43,3.77,4.22,3.62,3.54,4.11],[2.62,2.875,2.32,3.215,3.44,3.46,3.57,3.19,3.15,3.44,3.44,4.07,3.73,3.78,5.25,5.424,5.345,2.2,1.615,1.835,2.465,3.52,3.435,3.84,3.845,1.935,2.14,1.513,3.17,2.77,3.57,2.78],[16.46,17.02,18.61,19.44,17.02,20.22,15.84,20,22.9,18.3,18.9,17.4,17.6,18,17.98,17.82,17.42,19.47,18.52,19.9,20.01,16.87,17.3,15.41,17.05,18.9,16.7,16.9,14.5,15.5,14.6,18.6],[0,0,1,1,0,1,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,0,1,0,0,0,1],[1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1],[4,4,4,3,3,3,3,4,4,4,4,3,3,3,3,3,3,4,4,4,3,3,3,3,3,4,5,5,5,5,5,4],[4,4,1,1,2,1,4,2,2,4,4,3,3,3,4,4,4,1,2,1,1,2,2,4,2,1,2,2,4,6,8,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>mpg<\/th>\n      <th>cyl<\/th>\n      <th>disp<\/th>\n      <th>hp<\/th>\n      <th>drat<\/th>\n      <th>wt<\/th>\n      <th>qsec<\/th>\n      <th>vs<\/th>\n      <th>am<\/th>\n      <th>gear<\/th>\n      <th>carb<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="宽变长-pivot_longer" class="section level3">
<h3>宽变长 pivot_longer</h3>
<p>这里相当于是把数据变窄变长了</p>
<pre class="r"><code>long_data = mtcars %&gt;% 
  pivot_longer(
    -name,
    names_to = &#39;feature&#39;,
    values_to = &#39;value&#39;
  )

DT::datatable(long_data)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352"],["Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Mazda RX4 Wag","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Datsun 710","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet 4 Drive","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Hornet Sportabout","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Valiant","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Duster 360","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 240D","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 230","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 280C","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SE","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SL","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Merc 450SLC","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Cadillac Fleetwood","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Lincoln Continental","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Chrysler Imperial","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Fiat 128","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Honda Civic","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corolla","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Toyota Corona","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","Dodge Challenger","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","AMC Javelin","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Camaro Z28","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Pontiac Firebird","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Fiat X1-9","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Porsche 914-2","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Lotus Europa","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ford Pantera L","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Ferrari Dino","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Maserati Bora","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E","Volvo 142E"],["mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb","mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb"],[21,6,160,110,3.9,2.62,16.46,0,1,4,4,21,6,160,110,3.9,2.875,17.02,0,1,4,4,22.8,4,108,93,3.85,2.32,18.61,1,1,4,1,21.4,6,258,110,3.08,3.215,19.44,1,0,3,1,18.7,8,360,175,3.15,3.44,17.02,0,0,3,2,18.1,6,225,105,2.76,3.46,20.22,1,0,3,1,14.3,8,360,245,3.21,3.57,15.84,0,0,3,4,24.4,4,146.7,62,3.69,3.19,20,1,0,4,2,22.8,4,140.8,95,3.92,3.15,22.9,1,0,4,2,19.2,6,167.6,123,3.92,3.44,18.3,1,0,4,4,17.8,6,167.6,123,3.92,3.44,18.9,1,0,4,4,16.4,8,275.8,180,3.07,4.07,17.4,0,0,3,3,17.3,8,275.8,180,3.07,3.73,17.6,0,0,3,3,15.2,8,275.8,180,3.07,3.78,18,0,0,3,3,10.4,8,472,205,2.93,5.25,17.98,0,0,3,4,10.4,8,460,215,3,5.424,17.82,0,0,3,4,14.7,8,440,230,3.23,5.345,17.42,0,0,3,4,32.4,4,78.7,66,4.08,2.2,19.47,1,1,4,1,30.4,4,75.7,52,4.93,1.615,18.52,1,1,4,2,33.9,4,71.1,65,4.22,1.835,19.9,1,1,4,1,21.5,4,120.1,97,3.7,2.465,20.01,1,0,3,1,15.5,8,318,150,2.76,3.52,16.87,0,0,3,2,15.2,8,304,150,3.15,3.435,17.3,0,0,3,2,13.3,8,350,245,3.73,3.84,15.41,0,0,3,4,19.2,8,400,175,3.08,3.845,17.05,0,0,3,2,27.3,4,79,66,4.08,1.935,18.9,1,1,4,1,26,4,120.3,91,4.43,2.14,16.7,0,1,5,2,30.4,4,95.1,113,3.77,1.513,16.9,1,1,5,2,15.8,8,351,264,4.22,3.17,14.5,0,1,5,4,19.7,6,145,175,3.62,2.77,15.5,0,1,5,6,15,8,301,335,3.54,3.57,14.6,0,1,5,8,21.4,4,121,109,4.11,2.78,18.6,1,1,4,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>feature<\/th>\n      <th>value<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>可以看到原来的属性名mpg、cyl等都被合并到了feature列，对应的值都被合并到了value列。而且信息是一样的，没有损失。<br />
所以pivot_longer可以理解为把数据变长，那变长会吧原来的列整合成新的列，所以需要指定新的列名和值的列名。</p>
</div>
<div id="长变宽-pivot_wider" class="section level3">
<h3>长变宽 pivot_wider</h3>
<p>进行与上相反的操作，把刚才变长的数据恢复原来的样子。</p>
<pre class="r"><code>origin_data = long_data %&gt;% 
  pivot_wider(
    names_from = feature,
    values_from = value
  )

DT::datatable(origin_data)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["Mazda RX4","Mazda RX4 Wag","Datsun 710","Hornet 4 Drive","Hornet Sportabout","Valiant","Duster 360","Merc 240D","Merc 230","Merc 280","Merc 280C","Merc 450SE","Merc 450SL","Merc 450SLC","Cadillac Fleetwood","Lincoln Continental","Chrysler Imperial","Fiat 128","Honda Civic","Toyota Corolla","Toyota Corona","Dodge Challenger","AMC Javelin","Camaro Z28","Pontiac Firebird","Fiat X1-9","Porsche 914-2","Lotus Europa","Ford Pantera L","Ferrari Dino","Maserati Bora","Volvo 142E"],[21,21,22.8,21.4,18.7,18.1,14.3,24.4,22.8,19.2,17.8,16.4,17.3,15.2,10.4,10.4,14.7,32.4,30.4,33.9,21.5,15.5,15.2,13.3,19.2,27.3,26,30.4,15.8,19.7,15,21.4],[6,6,4,6,8,6,8,4,4,6,6,8,8,8,8,8,8,4,4,4,4,8,8,8,8,4,4,4,8,6,8,4],[160,160,108,258,360,225,360,146.7,140.8,167.6,167.6,275.8,275.8,275.8,472,460,440,78.7,75.7,71.1,120.1,318,304,350,400,79,120.3,95.1,351,145,301,121],[110,110,93,110,175,105,245,62,95,123,123,180,180,180,205,215,230,66,52,65,97,150,150,245,175,66,91,113,264,175,335,109],[3.9,3.9,3.85,3.08,3.15,2.76,3.21,3.69,3.92,3.92,3.92,3.07,3.07,3.07,2.93,3,3.23,4.08,4.93,4.22,3.7,2.76,3.15,3.73,3.08,4.08,4.43,3.77,4.22,3.62,3.54,4.11],[2.62,2.875,2.32,3.215,3.44,3.46,3.57,3.19,3.15,3.44,3.44,4.07,3.73,3.78,5.25,5.424,5.345,2.2,1.615,1.835,2.465,3.52,3.435,3.84,3.845,1.935,2.14,1.513,3.17,2.77,3.57,2.78],[16.46,17.02,18.61,19.44,17.02,20.22,15.84,20,22.9,18.3,18.9,17.4,17.6,18,17.98,17.82,17.42,19.47,18.52,19.9,20.01,16.87,17.3,15.41,17.05,18.9,16.7,16.9,14.5,15.5,14.6,18.6],[0,0,1,1,0,1,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,0,1,0,0,0,1],[1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1],[4,4,4,3,3,3,3,4,4,4,4,3,3,3,3,3,3,4,4,4,3,3,3,3,3,4,5,5,5,5,5,4],[4,4,1,1,2,1,4,2,2,4,4,3,3,3,4,4,4,1,2,1,1,2,2,4,2,1,2,2,4,6,8,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>mpg<\/th>\n      <th>cyl<\/th>\n      <th>disp<\/th>\n      <th>hp<\/th>\n      <th>drat<\/th>\n      <th>wt<\/th>\n      <th>qsec<\/th>\n      <th>vs<\/th>\n      <th>am<\/th>\n      <th>gear<\/th>\n      <th>carb<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>这里变宽可以理解为把一列拆分成多列，因此需要传入参数新列名称的来源，新列值的来源。<br />
细心的同学应该还会看到，pivot_wider里传递变量的名字和pivot_longer不同，后者变量名加了引号，可以简单记忆成如果该列在原有数据中已经存在就不需引号，否则加引号。</p>
</div>
<div id="更多长宽转换例子" class="section level3">
<h3>更多长宽转换例子</h3>
<pre class="r"><code>scores = data.frame(
  school = c(&quot;A&quot;, &quot;B&quot;, &quot;A&quot; ,&quot;B&quot; ,&quot;A&quot;, &quot;B&quot;),
  grade = c(&quot;grade_1&quot;,&quot;grade_2&quot;,&quot;grade_2&quot;,&quot;grade_2&quot;,&quot;grade_1&quot;,&quot;grade_1&quot;),
  gender = c(&quot;F&quot;, &quot;F&quot;, &quot;M&quot;, &quot;M&quot;, &quot;M&quot;, &quot;F&quot;),
  eng = c(90, 98, 78, 73, 82, 94),
  math = c(99, 100, 87, 89, 93, 99),
  physical = c(76, 78, 82, 83, 68, 74)
)

scores</code></pre>
<pre><code>##   school   grade gender eng math physical
## 1      A grade_1      F  90   99       76
## 2      B grade_2      F  98  100       78
## 3      A grade_2      M  78   87       82
## 4      B grade_2      M  73   89       83
## 5      A grade_1      M  82   93       68
## 6      B grade_1      F  94   99       74</code></pre>
<p>把学生成绩合并成一列</p>
<pre class="r"><code>long_data =  scores %&gt;% 
    pivot_longer(
      -c(school, grade, gender),
      names_to = &quot;subject&quot;,
      values_to = &quot;score&quot;
    )

DT::datatable(long_data)</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"],["A","A","A","B","B","B","A","A","A","B","B","B","A","A","A","B","B","B"],["grade_1","grade_1","grade_1","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_1","grade_1","grade_1","grade_1","grade_1","grade_1"],["F","F","F","F","F","F","M","M","M","M","M","M","M","M","M","F","F","F"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,98,100,78,78,87,82,73,89,83,82,93,68,94,99,74]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>grade<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>score<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":5},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="r"><code># 或者通过使用下面的方式实现同样的效果，和上面的区别在于前者是指定保留哪些列，这里是指定保留哪些列
# 指定的保持不变的列不会改变，只会在原有基础上进行(xing)行(hang)的复制扩充
# scores %&gt;% 
#     pivot_longer(
#       c(eng, math, physical),
#       names_to = &quot;subject&quot;,
#       values_to = &quot;score&quot;
#     )</code></pre>
<p>把学校信息拆分成两列</p>
<pre class="r"><code>DT::datatable(
  
  long_data %&gt;% 
  pivot_wider(
    names_from = school,
    values_from = score
  )
  
)</code></pre>
<div id="htmlwidget-5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["grade_1","grade_1","grade_1","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_1","grade_1","grade_1"],["F","F","F","F","F","F","M","M","M","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,null,null,null,78,87,82,82,93,68],[94,99,74,98,100,78,73,89,83,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>grade<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>A<\/th>\n      <th>B<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>把年级信息拆分成两列</p>
<pre class="r"><code>DT::datatable(
  
  long_data %&gt;% 
  pivot_wider(
    names_from = grade,
    values_from = score
  )
  
)</code></pre>
<div id="htmlwidget-6" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["A","A","A","B","B","B","A","A","A","B","B","B"],["F","F","F","F","F","F","M","M","M","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,94,99,74,82,93,68,null,null,null],[null,null,null,98,100,78,78,87,82,73,89,83]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>把学校和年级信息拆分成两列</p>
<pre class="r"><code>DT::datatable(
  
  long_data %&gt;% 
  pivot_wider(
    names_from = c(school, grade),
    values_from = score
  )
  
)</code></pre>
<div id="htmlwidget-7" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["F","F","F","M","M","M"],["eng","math","physical","eng","math","physical"],[90,99,76,82,93,68],[98,100,78,73,89,83],[null,null,null,78,87,82],[94,99,74,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>A_grade_1<\/th>\n      <th>B_grade_2<\/th>\n      <th>A_grade_2<\/th>\n      <th>B_grade_1<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>把学校和年级信息拆分成两列，使用names_glue参数自定义列名规则</p>
<pre class="r"><code>DT::datatable(
  
  long_data %&gt;% 
  pivot_wider(
    names_from = c(school, grade),
    values_from = score,
    names_glue = &quot;{grade}@{school}&quot;
  )
  
)</code></pre>
<div id="htmlwidget-8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["F","F","F","M","M","M"],["eng","math","physical","eng","math","physical"],[90,99,76,82,93,68],[98,100,78,73,89,83],[null,null,null,78,87,82],[94,99,74,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1@A<\/th>\n      <th>grade_2@B<\/th>\n      <th>grade_2@A<\/th>\n      <th>grade_1@B<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="数据分割与合并" class="section level2">
<h2>数据分割与合并</h2>
<div id="数据分割" class="section level3">
<h3>数据分割</h3>
<p>把原来的grade分割成两列， 新的grade只保留数字</p>
<pre class="r"><code>DT::datatable(
  
  scores %&gt;% 
  separate(grade, into = c(&quot;trash&quot;, &quot;grade&quot;))
  
)</code></pre>
<div id="htmlwidget-9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["A","B","A","B","A","B"],["grade","grade","grade","grade","grade","grade"],["1","2","2","2","1","1"],["F","F","M","M","M","F"],[90,98,78,73,82,94],[99,100,87,89,93,99],[76,78,82,83,68,74]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>trash<\/th>\n      <th>grade<\/th>\n      <th>gender<\/th>\n      <th>eng<\/th>\n      <th>math<\/th>\n      <th>physical<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="数据合并" class="section level3">
<h3>数据合并</h3>
<pre class="r"><code>new_data = scores %&gt;% 
    unite(&quot;score&quot;, eng, math, physical) %&gt;% 
    mutate(subject = &quot;eng_math_physical&quot;)

DT::datatable(
  new_data
)</code></pre>
<div id="htmlwidget-10" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-10">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["A","B","A","B","A","B"],["grade_1","grade_2","grade_2","grade_2","grade_1","grade_1"],["F","F","M","M","M","F"],["90_99_76","98_100_78","78_87_82","73_89_83","82_93_68","94_99_74"],["eng_math_physical","eng_math_physical","eng_math_physical","eng_math_physical","eng_math_physical","eng_math_physical"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>grade<\/th>\n      <th>gender<\/th>\n      <th>score<\/th>\n      <th>subject<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="数据分割-1" class="section level3">
<h3>数据分割</h3>
<p>针对上面的数据，如果不知道score是几个科目的拼接时，由于separate需要指定分割之后的名称，这里就会很麻烦。尤其是当有的学生有4科成绩，有的是3科时更麻烦，不过separate_rows()能够解决这个问题。<br />
这个函数能够把两列按照同样规则拼接起来的数据分割成多行。
仔细观察这个数据和上面数据的对应关系。</p>
<pre class="r"><code>DT::datatable(
  
  new_data %&gt;% 
  separate_rows(subject, score)
  
)</code></pre>
<div id="htmlwidget-11" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-11">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"],["A","A","A","B","B","B","A","A","A","B","B","B","A","A","A","B","B","B"],["grade_1","grade_1","grade_1","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_2","grade_1","grade_1","grade_1","grade_1","grade_1","grade_1"],["F","F","F","F","F","F","M","M","M","M","M","M","M","M","M","F","F","F"],["90","99","76","98","100","78","78","87","82","73","89","83","82","93","68","94","99","74"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>grade<\/th>\n      <th>gender<\/th>\n      <th>score<\/th>\n      <th>subject<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="缺失数据处理" class="section level2">
<h2>缺失数据处理</h2>
<pre class="r"><code>new_data =   long_data %&gt;% 
  pivot_wider(
    names_from = grade,
    values_from = score
  )

DT::datatable(
  new_data
)</code></pre>
<div id="htmlwidget-12" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-12">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["A","A","A","B","B","B","A","A","A","B","B","B"],["F","F","F","F","F","F","M","M","M","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,94,99,74,82,93,68,null,null,null],[null,null,null,98,100,78,78,87,82,73,89,83]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>可以看到这里有些数据是缺失的</p>
<div id="删除缺失的行" class="section level3">
<h3>删除缺失的行</h3>
<p>默认只要一行出现缺失值就删除</p>
<pre class="r"><code>DT::datatable(
  new_data %&gt;% 
  drop_na()
)</code></pre>
<div id="htmlwidget-13" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-13">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["B","B","B","A","A","A"],["F","F","F","M","M","M"],["eng","math","physical","eng","math","physical"],[94,99,74,82,93,68],[98,100,78,78,87,82]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>指定按照某些列是否缺失进行删除</p>
<pre class="r"><code>DT::datatable(
  new_data %&gt;% 
  drop_na(grade_1)
)</code></pre>
<div id="htmlwidget-14" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-14">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],["A","A","A","B","B","B","A","A","A"],["F","F","F","F","F","F","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,94,99,74,82,93,68],[null,null,null,98,100,78,78,87,82]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="填充缺失值" class="section level3">
<h3>填充缺失值</h3>
<p>使用fill填充缺失值，可以规定填充的方向。
“down”代表使用上面的填充，“up”代表使用下面的填充</p>
<pre class="r"><code>DT::datatable(
new_data %&gt;% 
  fill(grade_1, .direction = &quot;down&quot;)
)</code></pre>
<div id="htmlwidget-15" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-15">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["A","A","A","B","B","B","A","A","A","B","B","B"],["F","F","F","F","F","F","M","M","M","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,94,99,74,82,93,68,68,68,68],[null,null,null,98,100,78,78,87,82,73,89,83]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="替换缺失值" class="section level3">
<h3>替换缺失值</h3>
<p>分别使用各自平均分替换缺失值</p>
<pre class="r"><code>mean_grade_1 = mean(new_data$grade_1, na.rm = T)
mean_grade_2 = mean(new_data$grade_2, na.rm = T)


DT::datatable(
  
  new_data %&gt;% 
  replace_na(list(
    grade_1 = mean_grade_1, 
    grade_2 = mean_grade_2
  ))
  
)</code></pre>
<div id="htmlwidget-16" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-16">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["A","A","A","B","B","B","A","A","A","B","B","B"],["F","F","F","F","F","F","M","M","M","M","M","M"],["eng","math","physical","eng","math","physical","eng","math","physical","eng","math","physical"],[90,99,76,94,99,74,82,93,68,86.1111111111111,86.1111111111111,86.1111111111111],[85.3333333333333,85.3333333333333,85.3333333333333,98,100,78,78,87,82,73,89,83]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>school<\/th>\n      <th>gender<\/th>\n      <th>subject<\/th>\n      <th>grade_1<\/th>\n      <th>grade_2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div>
